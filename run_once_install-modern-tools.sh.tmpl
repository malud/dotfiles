#!/usr/bin/env bash
{{ if ne .chezmoi.os "darwin" -}}
set -euo pipefail

echo "üì¶ Installing modern CLI tools for Linux..."

# Detect package manager
if command -v apt-get &>/dev/null; then
  PKG_MGR="apt"
elif command -v dnf &>/dev/null; then
  PKG_MGR="dnf"
elif command -v yum &>/dev/null; then
  PKG_MGR="yum"
elif command -v apk &>/dev/null; then
  PKG_MGR="apk"
else
  echo "‚ö†Ô∏è  No supported package manager found"
  PKG_MGR="none"
fi

# Determine if we need sudo
USE_SUDO=false
if [ "$(id -u)" -ne 0 ] && command -v sudo &>/dev/null; then
  USE_SUDO=true
fi

install_with_cargo() {
  if ! command -v cargo &>/dev/null; then
    echo "üì¶ Installing Rust (needed for modern tools)..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi

  echo "üì¶ Installing via cargo..."
  cargo install "$@"
}

# Install tools based on package manager
case "$PKG_MGR" in
  apt)
    echo "üì¶ Using apt-get..."
    if [ "$USE_SUDO" = true ]; then
      sudo apt-get update
    else
      apt-get update
    fi

    # bat (often packaged as batcat)
    if ! command -v bat &>/dev/null && ! command -v batcat &>/dev/null; then
      if [ "$USE_SUDO" = true ]; then
        sudo apt-get install -y bat
      else
        apt-get install -y bat
      fi
      # Create symlink if installed as batcat
      if command -v batcat &>/dev/null && ! command -v bat &>/dev/null; then
        mkdir -p "$HOME/.local/bin"
        ln -sf "$(which batcat)" "$HOME/.local/bin/bat"
      fi
    fi

    # fd (often packaged as fd-find)
    if ! command -v fd &>/dev/null && ! command -v fdfind &>/dev/null; then
      if [ "$USE_SUDO" = true ]; then
        sudo apt-get install -y fd-find
      else
        apt-get install -y fd-find
      fi
      # Create symlink if installed as fdfind
      if command -v fdfind &>/dev/null && ! command -v fd &>/dev/null; then
        mkdir -p "$HOME/.local/bin"
        ln -sf "$(which fdfind)" "$HOME/.local/bin/fd"
      fi
    fi

    # ripgrep
    if ! command -v rg &>/dev/null; then
      if [ "$USE_SUDO" = true ]; then
        sudo apt-get install -y ripgrep
      else
        apt-get install -y ripgrep
      fi
    fi

    # fzf
    if ! command -v fzf &>/dev/null; then
      if [ "$USE_SUDO" = true ]; then
        sudo apt-get install -y fzf
      else
        apt-get install -y fzf
      fi
    fi

    # Essential development tools

    # Install Neovim (using AppImage for latest version - required for lazy.nvim which needs >= 0.8.0)
    if ! command -v nvim &>/dev/null; then
      echo "üì¶ Installing Neovim (latest stable via AppImage)..."
      mkdir -p "$HOME/.local/bin"

      # Download AppImage to temp directory first
      NVIM_TMP=$(mktemp -d)
      curl -sLo "$NVIM_TMP/nvim.appimage" https://github.com/neovim/neovim/releases/latest/download/nvim.appimage
      chmod +x "$NVIM_TMP/nvim.appimage"

      # Check if AppImage works, if not extract it
      if "$NVIM_TMP/nvim.appimage" --version &>/dev/null; then
        echo "üì¶ AppImage works, installing..."
        mv "$NVIM_TMP/nvim.appimage" "$HOME/.local/bin/nvim"
        rm -rf "$NVIM_TMP"
      else
        echo "üì¶ AppImage not supported (FUSE unavailable), extracting..."
        cd "$NVIM_TMP"

        # Extract AppImage - this creates squashfs-root directory
        ./nvim.appimage --appimage-extract >/dev/null 2>&1

        # Verify extraction succeeded
        if [ -d "squashfs-root" ]; then
          echo "‚úì Extraction successful"
          mv squashfs-root "$HOME/.local/bin/nvim-squashfs"
          ln -sf "$HOME/.local/bin/nvim-squashfs/usr/bin/nvim" "$HOME/.local/bin/nvim"
          cd - >/dev/null
          rm -rf "$NVIM_TMP"
        else
          echo "‚ö†Ô∏è Extraction failed, trying alternative installation method..."
          cd - >/dev/null
          rm -rf "$NVIM_TMP"

          # Fallback: try to install via apt (might be older version)
          if [ "$USE_SUDO" = true ]; then
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository -y ppa:neovim-ppa/unstable || true
            sudo apt-get update
            sudo apt-get install -y neovim
          else
            apt-get install -y neovim
          fi
        fi
      fi
    fi

    if ! command -v tmux &>/dev/null; then
      if [ "$USE_SUDO" = true ]; then
        sudo apt-get install -y tmux
      else
        apt-get install -y tmux
      fi
    fi

    if ! command -v git &>/dev/null; then
      if [ "$USE_SUDO" = true ]; then
        sudo apt-get install -y git
      else
        apt-get install -y git
      fi
    fi

    if ! command -v jq &>/dev/null; then
      if [ "$USE_SUDO" = true ]; then
        sudo apt-get install -y jq
      else
        apt-get install -y jq
      fi
    fi

    # yq (Go version - better than Python version)
    if ! command -v yq &>/dev/null; then
      echo "üì¶ Installing yq..."
      YQ_VERSION="v4.44.1"
      YQ_BINARY="yq_linux_amd64"
      curl -sL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/${YQ_BINARY}" -o "$HOME/.local/bin/yq"
      chmod +x "$HOME/.local/bin/yq"
    fi

    # kubectl (if not already installed)
    if ! command -v kubectl &>/dev/null; then
      echo "üì¶ Installing kubectl..."
      curl -sLO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      chmod +x kubectl
      mv kubectl "$HOME/.local/bin/"
    fi

    # krew (kubectl plugin manager)
    if ! command -v kubectl-krew &>/dev/null; then
      echo "üì¶ Installing krew..."
      (
        set -x; cd "$(mktemp -d)" &&
        OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
        ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" &&
        KREW="krew-${OS}_${ARCH}" &&
        curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
        tar zxvf "${KREW}.tar.gz" &&
        ./"${KREW}" install krew
      )
      export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
    fi

    # kustomize with helm plugin
    if ! command -v kustomize &>/dev/null; then
      echo "üì¶ Installing kustomize..."
      curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
      mv kustomize "$HOME/.local/bin/"

      # Install helm plugin for kustomize
      echo "üì¶ Installing kustomize helm plugin..."
      mkdir -p "$HOME/.config/kustomize/plugin"
      cd "$HOME/.config/kustomize/plugin"
      kustomize plugin install https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v5.0.0/kustomize_v5.0.0_linux_amd64.tar.gz || true
    fi

    # k9s
    if ! command -v k9s &>/dev/null; then
      echo "üì¶ Installing k9s..."
      K9S_VERSION="v0.32.5"
      curl -sL "https://github.com/derailed/k9s/releases/download/${K9S_VERSION}/k9s_Linux_amd64.tar.gz" -o /tmp/k9s.tar.gz
      tar -xzf /tmp/k9s.tar.gz -C /tmp
      mv /tmp/k9s "$HOME/.local/bin/"
      rm /tmp/k9s.tar.gz
    fi

    # eza and zoxide not in apt, install via cargo
    command -v eza &>/dev/null || install_with_cargo eza
    command -v zoxide &>/dev/null || install_with_cargo zoxide
    ;;

  dnf|yum)
    echo "üì¶ Using $PKG_MGR..."

    if [ "$USE_SUDO" = true ]; then
      command -v bat &>/dev/null || sudo "$PKG_MGR" install -y bat
      command -v fd &>/dev/null || sudo "$PKG_MGR" install -y fd-find
      command -v rg &>/dev/null || sudo "$PKG_MGR" install -y ripgrep
      command -v fzf &>/dev/null || sudo "$PKG_MGR" install -y fzf
    else
      command -v bat &>/dev/null || "$PKG_MGR" install -y bat
      command -v fd &>/dev/null || "$PKG_MGR" install -y fd-find
      command -v rg &>/dev/null || "$PKG_MGR" install -y ripgrep
      command -v fzf &>/dev/null || "$PKG_MGR" install -y fzf
    fi

    # eza and zoxide not in dnf/yum, install via cargo
    command -v eza &>/dev/null || install_with_cargo eza
    command -v zoxide &>/dev/null || install_with_cargo zoxide
    ;;

  apk)
    echo "üì¶ Using apk (Alpine)..."

    if [ "$USE_SUDO" = true ]; then
      command -v bat &>/dev/null || sudo apk add bat
      command -v fd &>/dev/null || sudo apk add fd
      command -v rg &>/dev/null || sudo apk add ripgrep
      command -v fzf &>/dev/null || sudo apk add fzf
    else
      command -v bat &>/dev/null || apk add bat
      command -v fd &>/dev/null || apk add fd
      command -v rg &>/dev/null || apk add ripgrep
      command -v fzf &>/dev/null || apk add fzf
    fi

    # eza and zoxide not in apk, install via cargo
    command -v eza &>/dev/null || install_with_cargo eza
    command -v zoxide &>/dev/null || install_with_cargo zoxide
    ;;

  none)
    echo "üì¶ Installing all tools via cargo..."
    install_with_cargo bat fd-find ripgrep eza zoxide

    # fzf via git
    if ! command -v fzf &>/dev/null; then
      git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
      ~/.fzf/install --bin
    fi
    ;;
esac

# Install starship (common to all platforms)
if ! command -v starship &>/dev/null; then
  echo "üì¶ Installing starship..."
  curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

echo ""
echo "‚úÖ Modern CLI tools installed!"
echo ""
echo "Tools available:"
command -v eza &>/dev/null && echo "  ‚úì eza (better ls)"
command -v bat &>/dev/null && echo "  ‚úì bat (better cat)"
command -v fd &>/dev/null && echo "  ‚úì fd (better find)"
command -v rg &>/dev/null && echo "  ‚úì rg (better grep)"
command -v fzf &>/dev/null && echo "  ‚úì fzf (fuzzy finder)"
command -v zoxide &>/dev/null && echo "  ‚úì zoxide (smarter cd)"
command -v starship &>/dev/null && echo "  ‚úì starship (prompt)"
command -v nvim &>/dev/null && echo "  ‚úì neovim (editor)"
command -v tmux &>/dev/null && echo "  ‚úì tmux (terminal multiplexer)"
command -v git &>/dev/null && echo "  ‚úì git (version control)"
command -v jq &>/dev/null && echo "  ‚úì jq (JSON processor)"
command -v yq &>/dev/null && echo "  ‚úì yq (YAML processor)"
command -v kubectl &>/dev/null && echo "  ‚úì kubectl (kubernetes CLI)"
command -v kubectl-krew &>/dev/null && echo "  ‚úì krew (kubectl plugin manager)"
command -v kustomize &>/dev/null && echo "  ‚úì kustomize (kubernetes config management with helm plugin)"
command -v k9s &>/dev/null && echo "  ‚úì k9s (kubernetes TUI)"
echo ""
echo "‚ÑπÔ∏è  Note: Nerd Font icons are rendered by your local terminal/VSCode"
echo "   Ensure 'SauceCodePro Nerd Font' is installed on your host system (macOS)"

{{ else -}}
echo "‚ö†Ô∏è  This script is for non-macOS systems only"
echo "‚ÑπÔ∏è  On macOS, use Homebrew: brew bundle"
exit 0
{{ end -}}
