#!/usr/bin/env bash
{{ if ne .chezmoi.os "darwin" -}}
set -euo pipefail

echo "üì¶ Installing Ansible..."

# Check if Ansible is already installed
if command -v ansible-playbook &>/dev/null; then
  echo "‚úÖ Ansible already installed ($(ansible --version | head -n1))"
  exit 0
fi

# Detect package manager
if command -v apt-get &>/dev/null; then
  PKG_MGR="apt"
elif command -v dnf &>/dev/null; then
  PKG_MGR="dnf"
elif command -v yum &>/dev/null; then
  PKG_MGR="yum"
elif command -v apk &>/dev/null; then
  PKG_MGR="apk"
elif command -v pacman &>/dev/null; then
  PKG_MGR="pacman"
else
  echo "‚ùå No supported package manager found"
  exit 1
fi

# Determine if we need sudo
USE_SUDO=""
if [ "$(id -u)" -ne 0 ] && command -v sudo &>/dev/null; then
  USE_SUDO="sudo"
fi

# Install Ansible based on package manager
case "$PKG_MGR" in
  apt)
    echo "üì¶ Using apt-get to install Ansible..."
    export DEBIAN_FRONTEND=noninteractive
    $USE_SUDO apt-get update
    $USE_SUDO apt-get install -y ansible
    ;;
  dnf)
    echo "üì¶ Using dnf to install Ansible..."
    $USE_SUDO dnf install -y ansible
    ;;
  yum)
    echo "üì¶ Using yum to install Ansible..."
    $USE_SUDO yum install -y epel-release
    $USE_SUDO yum install -y ansible
    ;;
  apk)
    echo "üì¶ Using apk to install Ansible..."
    $USE_SUDO apk add --no-cache ansible
    ;;
  pacman)
    echo "üì¶ Using pacman to install Ansible..."
    $USE_SUDO pacman -Sy --noconfirm ansible
    ;;
  *)
    echo "‚ùå Unsupported package manager: $PKG_MGR"
    exit 1
    ;;
esac

# Verify installation
if command -v ansible-playbook &>/dev/null; then
  echo "‚úÖ Ansible installed successfully!"
  ansible --version | head -n1
else
  echo "‚ùå Ansible installation failed"
  exit 1
fi

{{ else -}}
echo "‚ÑπÔ∏è  This script is for Linux only - skipping on macOS"
exit 0
{{ end -}}

